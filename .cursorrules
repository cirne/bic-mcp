# BIC MCP Server - Project Context

## Project Overview
MCP server for querying grant transaction data from Beloved In Christ Foundation. Loads data from CSV files in `data/` directory.

---

## PART A: Using the MCP Server

### Query Strategy

**Top Grantees:** Always use `list_grantees` with `sort_by: "total_amount"` - never use `list_transactions` with post-processing.

**Finding Charity Names:** Use `list_grantees({ sort_by: "name" })` first, then use exact `charity` parameter (not `search_term`).

**Common Patterns:**
- Charity since year: `list_transactions({ charity: "Name", min_year: 2023, sort_by: "Sent Date", sort_order: "desc" })`
- Yearly summary: `show_grantee({ charity: "Name" })` (returns yearly totals automatically)
- Large grants: `list_transactions({ year: 2024, min_amount: 25000, sort_by: "Amount", sort_order: "desc" })`
- Top grantees: `list_grantees({ year: 2024, sort_by: "total_amount", sort_order: "desc" })`
- Category breakdown: `aggregate_transactions({ group_by: "category", year: 2024, sort_by: "total_amount", sort_order: "desc" })`
- International vs domestic: **Use `list_grantees({ year: 2024 })`** - it already returns `international` (boolean) and `total_amount` for each grantee, so you can simply sum amounts grouped by `international` status. This is the simplest approach - no need for `aggregate_transactions` or custom aggregation code.

### Response Formatting
- Format amounts: "$500,000" not "500000.00"
- Format dates: "October 2, 2025" not "10/2/25"
- Include totals (count, sum) when showing multiple transactions
- Group multi-year data by year
- Include Sent Date, Amount, Grant Purpose in responses

### Special Grantee Relationships

When asked about these organizations, **include grants to related entities**:

#### FRISBE → Trinity College School (TCS)
- **FRISBE** (EIN: 91-1216755) is a U.S. conduit for **Trinity College School** in Canada
- Include grants to both "Trinity College School Fund Inc." (EIN: 13-6187951) and "Friends of Independent Schools and Better Education (FRISBE)"
- Clarify that FRISBE grants go to Trinity College School Foundation

#### Latin American Fellowship → Los Cabos Programs
- **Latin American Fellowship INC** (EIN: 93-6033108, Albany, OR) is a conduit for **Los Cabos special programs** in Baja California Sur, Mexico
- Supports ministries, food banks, and community programs in Los Cabos/BCS region
- Clarify that grants are for Los Cabos programs

#### Freedom Generation Church → Dean Braxton Ministries
- **Freedom Generation Church** (EIN: 75-3094503) fiscally sponsors **Dean Braxton Ministries**
- Many grants explicitly state "Donation for Dean Braxton Ministries" in grant purpose
- Clarify that grants support Dean Braxton Ministries

### Grant Categorization

When categorizing grants, use these four buckets:

#### *Evangelism*
- Organizations focused on evangelism and outreach
- Examples: Young Life, Pine Cove, Luis Palau Association, etc.

#### *Matthew 25* (Supporting the Needy)
- Organizations supporting widows, orphans, and those in need
- Examples: Bright City Ministries (James 29 fund to support widows and orphans), food banks, etc.

#### *Education/Schools*
- Educational institutions and school-related organizations
- Examples: He Touched Me (Zambia school), Trinity College School (TCS), Faith Academy, University of Texas, etc.

#### *Churches/Offerings*
- All churches and church offerings (excluding Bright City Ministries, which is categorized under Matthew 25)

### When to Use Each Tool
- **`list_transactions`**: Search/filter individual transactions (amounts, dates, purposes). Returns transactions with `Category` and `International` fields.
- **`list_grantees`**: Aggregated grantee data, especially top grantees queries. Returns `international` field for each grantee.
- **`show_grantee`**: Complete grantee history with yearly totals. Returns `international` field in metadata.
- **`aggregate_transactions`**: Summary statistics grouped by category, grantee, or year. Returns count and total_amount for each group. Only includes "Payment Cleared" grants. Use for category breakdowns, yearly totals, or grantee summaries.

---

## PART B: Development Guidelines

### File Creation Guidelines

**IMPORTANT:** Before creating new files, ask for user permission if the file is:
- A documentation markdown file (`.md` files) - unless explicitly requested
- A one-off or temporary test script (e.g., `test-*.js`, `manual-test-*.js`) - unless explicitly requested
- Any temporary or experimental file

**Do NOT create** documentation files or one-off test scripts without explicit user approval. The codebase should remain clean and not be polluted with temporary files.

**Exceptions:** 
- Files explicitly requested by the user
- Standard test files in the test suite (e.g., `*.test.ts` files using Vitest)
- Files that are part of the project structure (e.g., configuration files, source code files)

### Data Structure
- **Dates**: Format M/D/YY (e.g., "10/2/25" = October 2, 2025). Years 00-30 = 2000-2030, 31-99 = 1931-1999
- **Amounts**: Strings with commas and trailing spaces (e.g., "500,000.00 "). Parse: `amountStr.replace(/,/g, '').replace(/\s/g, '')` then `parseFloat()`
- **Key Fields**: Transaction ID, Charity, Amount, Sent Date, Grant Purpose, EIN, Grant Status

### MCP Tools

#### `list_transactions` - Search/filter transactions
**Parameters:** `search_term`, `charity` (exact match), `grant_status` (e.g., "Pending", "Payment Cleared", "Cancelled", "Reversed", "Denied"), `year`/`min_year`/`max_year`, `min_amount`/`max_amount`, `sort_by`, `sort_order`, `group_by`, `fields`

#### `list_grantees` - List grantees with aggregated totals
**Parameters:** `year`, `sort_by` ("name", "ein", "recent_date", "total_amount"), `sort_order`
**Returns:** Name, EIN, transaction count, total_amount, most recent grant note
**Use for:** Top grantees queries - provides pre-calculated totals, no post-processing needed

#### `show_grantee` - Detailed grantee info
**Parameters:** `charity` (required, exact name)
**Returns:** Metadata (including `international`), yearly totals, all transactions

#### `aggregate_transactions` - Aggregate transactions with summary statistics
**Parameters:** 
- `group_by` (required): "category", "grantee", "year", "international", "is_beloved", or "status"
- `year`/`min_year`/`max_year`: Filter by year range
- `min_amount`/`max_amount`: Filter by amount range
- `category`: Filter by category when grouping by grantee or year
- `charity`: Filter by exact charity name when grouping by category or year
- `sort_by`: "count", "total_amount", or "name" (default: "total_amount")
- `sort_order`: "asc" or "desc" (default: "desc")
**Returns:** Array of objects with `name`, `count`, and `total_amount` for each group
**Use for:** Category breakdowns, yearly totals, grantee summaries, international vs domestic analysis, status breakdowns
**Note:** Only includes "Payment Cleared" grants (unless grouping by status, in which case all statuses are included)

### Implementation Notes
- Fuzzy search uses Fuse.js (threshold 0.4)
- Grantees identified by Charity name + EIN
- Use "Sent Date" as primary date field
- Validate all inputs (type, range, required fields)
